<!DOCTYPE html>
<html>
  <head>
    <title>GamePad sample</title>
    <meta charset="utf-8">
  </head>

  <body id="root">
    <article>
      <h1>GamePad Sample</h1>
      <button id="capture">capture</button>
      <button id="stop">stop</button>
      <div id="key-mapper">
        <ul>
          <li><span id="cursor0"></span>button1: <span id="key-button-1">0</span> <button id="setup-button-1">Set</button></li>
          <li><span id="cursor1"></span>button2: <span id="key-button-2">1</span> <button id="setup-button-2">Set</button></li>
          <li><span id="cursor2"></span>button3: <span id="key-button-3">2</span> <button id="setup-button-3">Set</button></li>
          <li><span id="cursor3"></span>button4: <span id="key-button-4">3</span> <button id="setup-button-4">Set</button></li>
          <li><span id="cursor4"></span>axis1: <span id="key-axis-x">0</span> <button id="setup-axis-x">Set</button></li>
          <li><span id="cursor5"></span>axis2: <span id="key-axis-y">1</span> <button id="setup-axis-y">Set</button></li>
        </ul>
      </div>
    </article>

    <script type="module">
      import { GamePads } from './src/main.js';
      import { GamePadMapper, keyType } from './src/padMapper.js';

      const gamePads = new GamePads();
      const keys = [
        { name: 'button-1', type: keyType.button, index: 0 },
        { name: 'button-2', type: keyType.button, index: 1 },
        { name: 'button-3', type: keyType.button, index: 2 },
        { name: 'button-4', type: keyType.button, index: 3 },
        { name: 'axis-x', type: keyType.axis, index: 0 },
        { name: 'axis-y', type: keyType.axis, index: 1 }
      ];

      const padMapper = new GamePadMapper(gamePads, keys);

      // UI
      const captureButton = document.getElementById('capture');
      const stopButton = document.getElementById('stop');
      stopButton.style.display = 'none';

      stopButton.addEventListener('click', () => {
        padMapper.stop();
      });

      // set event hander to buttons
      keys.map(key => key.name).forEach(keyName => {
        const targetButton = document.getElementById(`setup-${keyName}`);
        targetButton.addEventListener('click', async () => {
          await padMapper.register(keyName);
        });
      });

      // Show the result of key mappings
      padMapper.addEventHandler('applied', e => {
        document.getElementById(`key-${e.name}`).innerText = e.index;
      });

      gamePads.capture();
      gamePads.addEventHandler('connected', e => {
        gamePads.setIndex(0);

        captureButton.addEventListener('click', () => {
          console.log('capturing');
          padMapper.resetStepBy();
          padMapper.registerAll();
          stopButton.style.display = '';
          captureButton.style.display = 'none';
        });

        padMapper.addEventHandler('buttonChanged', e => console.log(`Button ${e.index} ${e.name} : ${e.value.pressed}`));
        padMapper.addEventHandler('axisChanged', e => console.log(`Axis ${e.index} ${e.name} : ${e.value}`));
      });

      padMapper.addEventHandler('cursorChanged', e => {
        keys.forEach((_key, index) => {
          document.getElementById(`cursor${index}`).innerText = '';
        });
        if( e.cursor >= 0 ) document.getElementById(`cursor${e.cursor}`).innerText = '->';
      });

      padMapper.addEventHandler('registerCompleted', e => {
        console.log('captured');
        stopButton.style.display = 'none';
        captureButton.style.display = '';
      });
    </script>
  </body>
</html>
